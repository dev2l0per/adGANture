<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <title>adGANture</title>
    <style type="text/css">
      .hidden {
        display: none;
      }

      .load {
        position: absolute;
        justify-content: center;
        align-items: center;
      }

      .spin {
        background-color: #00000060;
        height: 150px;
        width: 150px;
        border-radius: 150px;
        border: 5px solid #00000000;
        border-top: 5px solid #ffffff;
        animation: loading 2s linear infinite;
      }

      .loading {
        position: absolute;
        color: #ffffff;
        font-family: Arial, Helvetica, sans-serif;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      @keyframes loading {
        100% {
          transform: rotate(360deg);
        }
      }

      #file-upload-form {
        margin-right: 5%;
      }

      .footer {
        position: absolute;
        bottom: 0;
        width: 100%;
      }
    </style>
</head>

<body>
    <main>
      <header>
        <div class="p-3 bg-dark text-white">
            <div class="container">
                <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
                    <a href="/" class="d-flex align-items-center my-2 my-lg-0 me-lg-auto text-white text-decoration-none">
                        <h4>adGANture</h4>
                    </a>
                    <ul class="nav col-12 col-lg-auto my-2 justify-content-center my-md-0 text-small">
                      <li>
                        <a href="https://github.com/dev2l0per/adGANture" class="nav-link text-white" target="_blank">
                          <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-github" viewBox="0 0 18 18">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                          </svg>
                          Github
                        </a>
                      </li>
                    </ul>
                </div>
            </div>
        </div>
      </header>
      <div class="container">
          <div class="container" style="margin-top: 20px;">
              <h3 style="margin-bottom: 20px;">How to use ?</h3>
              <ul class="list-group">
                  <li class="list-group-item">
                    1. Select the Category, Model, Endpoint in order.
                  </li>
                  <li class="list-group-item">
                    2. Fill in form according to format.
                  </li>
                  <li class="list-group-item">
                    3. Click submit button and Check the result below.
                  </li>
                  <li class="list-group-item">
                    4. Submit other apis and compare them.
                  </li>
              </ul>
          </div>
          <div class="container">
            <hr>
            <div class="nav nav-pills flex-row mb-auto dropdown justify-content-evenly">
              <a href="#" class="d-flex align-items-center text-black text-decoration-none dropdown-toggle" id="dropdown-category" data-bs-toggle="dropdown" aria-expanded="false">
                <strong id="selected-category">Select Category</strong>
              </a>
              <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-macos mx-0 border-0 shadow" id="category-list" style="width: 250px;" aria-labelledby="dropdown-category">
              </ul>
              <a href="#" class="d-flex align-items-center text-black text-decoration-none dropdown-toggle" id="dropdown-model" data-bs-toggle="dropdown" aria-expanded="false">
                <strong id="selected-model">Select Model</strong>
              </a>
              <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-macos mx-0 border-0 shadow" id="model-list" style="width: 250px;" aria-labelledby="dropdown-model">
              </ul>
              <a href="#" class="d-flex align-items-center text-black text-decoration-none dropdown-toggle" id="dropdown-endpoint" data-bs-toggle="dropdown" aria-expanded="false">
                <strong id="selected-endpoint">Select Endpoint</strong>
              </a>
              <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-macos mx-0 border-0 shadow" id="endpoint-list" style="width: 250px;" aria-labelledby="dropdown-endpoint">
              </ul>
            </div>
            <hr>
          </div>
          <div class="container" style="display: flex; justify-content: center; margin-top: 20px; position: relative; align-items: center;">
            <div class="load hidden" style="position: absolute;">
              <div class="spin"></div>
              <div class="loading">LOADING</div>
            </div>
            <form id="file-upload-form" class="uploader row justify-content-center">
              
            </form>
          </div>
          <div class="row row-cols-1 row-cols-md-4 g-4" style="margin-top: 20px" id="result-container">
            
          </div>
      </div>
      <footer class="footer mt-auto py-3 bg-light">
        <div class="container text-center">
          <span class="text-muted">
          <a href="https://ainize.ai/dev2l0per/adGANture?branch=api" target="_blank" class="text-muted fs-6 fw-light text-decoration-none">Powered by Ainize</p>
          </span>
        </div>
      </footer>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script>
        const selectedCategory = document.getElementById('selected-category');
        const selectedModel = document.getElementById('selected-model');
        const selectedEndpoint = document.getElementById('selected-endpoint');
        const fileUploadForm = document.getElementById('file-upload-form');

        let modelInfo = {};

        function clearFileUploadForm() {
          const existedRow = fileUploadForm.querySelectorAll('.row');
          
          for (let i = 0; i < existedRow.length; ++i) {
            fileUploadForm.removeChild(existedRow[i]);
          }
        }

        const selectCategoryObserver = new MutationObserver((mutations) => {
          const category = mutations[0].target.textContent;

          fetch('/category/' + category, {
            method: 'GET',
          }).then((response) => {
            if (response.status == 200) {
              return response
            } else {
              throw Error('Server Error');
            }
          }).then((response) => {
            return response.json();
          }).then((response) => {
            const modelList = document.getElementById('model-list');
            modelList.innerHTML = '';
            selectedModel.textContent = 'Select Model';
            selectedEndpoint.textContent = 'Select Endpoint';

            for (model in response) {
              const li = document.createElement('li');
              const button = document.createElement('button');

              button.classList.add('dropdown-item');
              button.setAttribute('onclick', 'selectItem(this);');
              button.textContent = model;
              li.append(button);
              modelList.appendChild(button);
            }
          });
        });

        const selectModelObserver = new MutationObserver((mutations) => {
          const model = mutations[0].target.textContent;

          if  (model != 'Select Model') {
            fetch('/category/' + selectedCategory.textContent + '/' + model, {
              method: 'GET',
            }).then((response) => {
              if (response.status == 200) {
                return response;
              } else {
                throw Error('Server Error');
              }
            }).then((response) => {
              return response.json();
            }).then((response) => {
              const endpointList = document.getElementById('endpoint-list');
              endpointList.innerHTML = '';
              selectedEndpoint.textContent = 'Select Endpoint';
              modelInfo = response;
  
              for (endpoint in response['endpoints']) {
                const li = document.createElement('li');
                const button = document.createElement('button');
  
                button.classList.add('dropdown-item');
                button.setAttribute('onclick', 'selectItem(this);');
                button.textContent = endpoint;
                li.append(button);
                endpointList.appendChild(button);
              }
            });
          }
        });

        const selectEndpointObserver = new MutationObserver((mutations) => {
          const endpoint = mutations[0].target.textContent;
          
          clearFileUploadForm();
          
          if (modelInfo['endpoints'][endpoint] != undefined) {
            const parameters = modelInfo['endpoints'][endpoint];
            const submitButton = document.createElement('button');

            fileUploadForm.classList.remove('hidden');

            {
              const rowDiv = document.createElement('div');
              const colDiv = document.createElement('div');
              const githubBtn = document.createElement('a');
              const ainizeBtn = document.createElement('a');

              rowDiv.classList.add('row');
              rowDiv.setAttribute('style', 'margin-bottom: 10px;');
              colDiv.classList.add('col', 'text-end');
              githubBtn.classList.add('btn', 'btn-outline-primary', 'me-2');
              githubBtn.textContent = "Github Repo";
              githubBtn.setAttribute('href', modelInfo['github']);
              githubBtn.setAttribute('target', '_blank');
              ainizeBtn.classList.add('btn', 'btn-outline-primary', 'me-2');
              ainizeBtn.textContent = 'API on Ainize';
              ainizeBtn.setAttribute('href', modelInfo['ainize']);
              ainizeBtn.setAttribute('target', '_blank');

              colDiv.append(githubBtn, ainizeBtn);
              rowDiv.append(colDiv);
              fileUploadForm.append(rowDiv);
            }

            for (parameter in parameters) {
              if (parameter == 'file') {
                for (parameterName in parameters[parameter]) {
                  const rowDiv = document.createElement('div');
                  const colDiv = document.createElement('div');
                  const label = document.createElement('label');
                  const input = document.createElement('input');
                  const img = document.createElement('img');

                  rowDiv.classList.add('row');
                  rowDiv.setAttribute('style', 'margin-bottom: 10px;');
                  colDiv.classList.add('col-sm-10');
                  label.classList.add('col-sm-2', 'col-form-label', 'text-break');
                  label.setAttribute('for', parameterName);
                  label.setAttribute('style', 'margin: auto; text-align: center;');
                  label.textContent = parameterName;
                  input.classList.add('input-image', 'form-control');
                  input.type = "file";
                  input.setAttribute('name', parameterName);
                  input.setAttribute('accept', 'image/*');
                  input.setAttribute('style', "display: inline;");
                  img.classList.add('preview-image', 'd-none');
                  img.setAttribute('alt', parameterName);
                  img.setAttribute('style', 'width: 300px;');
                  input.setAttribute('onchange', 'uploadImagePreview(this);');

                  colDiv.append(input, img);
                  rowDiv.append(label, colDiv);
                  fileUploadForm.append(rowDiv);
                }
              } else if (parameter == 'string') {
                for (parameterName in parameters[parameter]) {
                  const rowDiv = document.createElement('div');
                  const label = document.createElement('label');
                  const colDiv = document.createElement('div');
                  const input = document.createElement('input');
                  const dataList = document.createElement('datalist');
                  
                  rowDiv.classList.add('row');
                  rowDiv.setAttribute('style', 'margin-bottom: 10px;');
                  label.classList.add('col-sm-2', 'col-form-label', 'text-break');
                  label.setAttribute('for', parameterName);
                  label.setAttribute('style', 'margin: auto; text-align: center;');
                  label.textContent = parameterName;
                  colDiv.classList.add('col-sm-10');
                  input.type = "text";
                  input.classList.add('form-control');
                  input.setAttribute('list', parameterName);
                  dataList.id = parameterName;

                  for (example of parameters[parameter][parameterName]) {
                    const option = document.createElement('option');

                    option.value = example;
                    option.label = example;

                    dataList.append(option)
                  }
                  
                  colDiv.append(input, dataList);
                  rowDiv.append(label, colDiv);
                  fileUploadForm.append(rowDiv);
                }
              }
            }
            const rowDiv = document.createElement('div');

            rowDiv.classList.add('row');

            submitButton.classList.add('btn', 'btn-primary');
            submitButton.id = 'submit';
            submitButton.textContent = 'Submit';
            submitButton.setAttribute('onclick', 'submitForm();');

            rowDiv.append(submitButton);
            fileUploadForm.append(rowDiv);

          } else {
            fileUploadForm.classList.add('hidden');
          }
        });

        const observerConfig = {
          childList: true,
        };
        
        selectCategoryObserver.observe(selectedCategory, observerConfig);
        selectModelObserver.observe(selectedModel, observerConfig);
        selectEndpointObserver.observe(selectedEndpoint, observerConfig);
        
        fetch("/category", {
          method: 'GET',
        }).then((response) => {
          if (response.status == 200) {
            return response;
          } else {
            throw Error('Server Error');
          }
        }).then((response) => {
          return response.json();
        }).then((response) => {
          const categoryList = document.getElementById('category-list');
          
          for (category of response) {
            const li = document.createElement('li');
            const button = document.createElement('button');

            button.classList.add('dropdown-item');
            button.setAttribute('onclick', 'selectItem(this);');
            button.textContent = category;
            li.append(button);
            categoryList.appendChild(button);
          }
        });

        function uploadImagePreview(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();

                reader.onload = (e) => {
                    const previewImage = document.querySelector('.preview-image[alt=' + input.getAttribute('name') + ']');
                    previewImage.src = e.target.result;
                    previewImage.classList.remove('d-none');
                }

                reader.readAsDataURL(input.files[0]);
            }
        }

        function selectItem(element) {
          const dropDownList = element.parentElement;
          const selectedItem = document.getElementById(dropDownList.getAttribute('aria-labelledby'));

          selectedItem.firstElementChild.innerHTML = element.textContent;
        }

        function submitForm() {
          const submitButton = document.getElementById('submit');
          const formRowList = fileUploadForm.getElementsByClassName('row');
          const inputImageList = document.querySelectorAll('.input-image');
          const loadingCircle = document.querySelector('.load');
          
          submitButton.disabled = true;
          fileUploadForm.setAttribute('style', 'opacity: 0.3;');
          loadingCircle.classList.remove('hidden');

          const formData = new FormData();
          formData.append('category', selectedCategory.textContent);
          formData.append('model', selectedModel.textContent);
          formData.append('endpoint', selectedEndpoint.textContent);
          inputImageList.forEach((inputImage) => {
            formData.append(inputImage.getAttribute('name'), inputImage.files[0]);
          })

          for (let i = inputImageList.length + 1; i < formRowList.length - 1; ++i) {
            const key = formRowList[i].querySelector('label').getAttribute('for');

            const formSelect = formRowList[i].querySelector('input[list=' + key + ']');
            formData.append(key, formSelect.value);
          }

          fetch('/gan', {
            method: 'POST',
            body: formData,
          }).then((response) => {
            if (response.status == 200) {
              return response;
            } else {
              return response.text().then((text) => { throw new Error(text) });
            }
          }).then((response) => {
            return response.blob();
          }).then((response) => {
            const url = URL.createObjectURL(response);
            const resultContainer = document.getElementById('result-container');
            
            const colDiv = document.createElement('div');
            const cardDiv = document.createElement('div');
            const cardHeaderDiv = document.createElement('div');
            const img = document.createElement('img');

            colDiv.classList.add('col');
            cardDiv.classList.add('card');
            cardDiv.setAttribute('style', 'width: 300px;');
            cardHeaderDiv.classList.add('card-header', 'text-center');
            cardHeaderDiv.textContent = selectedModel.textContent;
            img.classList.add('card-img-top');

            img.width = 300;
            img.height = 300;
            img.src = url;

            cardDiv.append(cardHeaderDiv, img);
            colDiv.append(cardDiv);
            resultContainer.append(colDiv);
            clearFileUploadForm();
            loadingCircle.classList.add('hidden');
            fileUploadForm.removeAttribute('style');
          }).catch((e) => {
            alert(e);
            submitButton.disabled = false;
            loadingCircle.classList.add('hidden');
            fileUploadForm.removeAttribute('style');
          });
        }
    </script>
</body>

</html>