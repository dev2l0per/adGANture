<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <title>adGANture</title>
    <style type="text/css">
      .hidden {
        display: none;
      }
    </style>
</head>

<body>
    <main>
        <header class="p-3 bg-dark text-white">
            <div class="container">
                <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
                    <a href="/" class="d-flex align-items-center mb-2 mb-lg-0 text-white text-decoration-none">
                        <h4>adGANture</h4>
                    </a>
                </div>
            </div>
        </header>
        <div class="container">
            <div class="container" style="margin-top: 20px;">
                <h3 style="margin-bottom: 20px;">How to use ?</h3>
                <ul class="list-group">
                    <li class="list-group-item">
                      1. Select Category, Model, Endpoint
                    </li>
                    <li class="list-group-item">
                      2. Fill in form according to format
                    </li>
                    <li class="list-group-item">
                      3. Click Submit !
                    </li>
                </ul>
            </div>
            <div class="container">
              <hr>
              <div class="nav nav-pills flex-row mb-auto dropdown justify-content-evenly">
                <a href="#" class="d-flex align-items-center text-black text-decoration-none dropdown-toggle" id="dropdown-category" data-bs-toggle="dropdown" aria-expanded="false">
                  <strong id="selected-category">Select Category</strong>
                </a>
                <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-macos mx-0 border-0 shadow" id="category-list" style="width: 250px;" aria-labelledby="dropdown-category">
                </ul>
                <a href="#" class="d-flex align-items-center text-black text-decoration-none dropdown-toggle" id="dropdown-model" data-bs-toggle="dropdown" aria-expanded="false">
                  <strong id="selected-model">Select Model</strong>
                </a>
                <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-macos mx-0 border-0 shadow" id="model-list" style="width: 250px;" aria-labelledby="dropdown-model">
                </ul>
                <a href="#" class="d-flex align-items-center text-black text-decoration-none dropdown-toggle" id="dropdown-endpoint" data-bs-toggle="dropdown" aria-expanded="false">
                  <strong id="selected-endpoint">Select Endpoint</strong>
                </a>
                <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-macos mx-0 border-0 shadow" id="endpoint-list" style="width: 250px;" aria-labelledby="dropdown-endpoint">
                </ul>
              </div>
              <hr>
            </div>
            <div class="container" style="display: flex; justify-content: center; margin-top: 20px;">
                <form id="file-upload-form" class="uploader" style="margin-right: 5%">
                  <div class="row">
                    <div class="col">
                      <input id="input-image" type="file" name="" accept="image/*" />
                      <img id="preview-image" src="" alt="Upload Image" style="width: 300px; height: 300px;" />
                    </div>
                  </div>
                </form>
            </div>
            <div class="container" style="margin-top: 20px" id="result-container">
              
            </div>
        </div>
        
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script>
        const inputImage = document.getElementById('input-image');
        const selectedCategory = document.getElementById('selected-category');
        const selectedModel = document.getElementById('selected-model');
        const selectedEndpoint = document.getElementById('selected-endpoint');
        const fileUploadForm = document.getElementById('file-upload-form');

        let modelInfo = {};

        const selectCategoryObserver = new MutationObserver((mutations) => {
          const category = mutations[0].target.textContent;

          fetch('/category/' + category, {
            method: 'GET',
          }).then((response) => {
            if (response.status == 200) {
              return response
            } else {
              throw Error('Server Error');
            }
          }).then((response) => {
            return response.json();
          }).then((response) => {
            const modelList = document.getElementById('model-list');
            modelList.innerHTML = '';
            selectedModel.textContent = 'Select Model';
            selectedEndpoint.textContent = 'Select Endpoint';

            for (model in response) {
              const li = document.createElement('li');
              const button = document.createElement('button');

              button.classList.add('dropdown-item');
              button.setAttribute('onclick', 'selectItem(this);');
              button.textContent = model;
              li.append(button);
              modelList.appendChild(button);
            }
          });
        });

        const selectModelObserver = new MutationObserver((mutations) => {
          const model = mutations[0].target.textContent;

          if  (model != 'Select Model') {
            fetch('/category/' + selectedCategory.textContent + '/' + model, {
              method: 'GET',
            }).then((response) => {
              if (response.status == 200) {
                return response;
              } else {
                throw Error('Server Error');
              }
            }).then((response) => {
              return response.json();
            }).then((response) => {
              const endpointList = document.getElementById('endpoint-list');
              endpointList.innerHTML = '';
              selectedEndpoint.textContent = 'Select Endpoint';
              modelInfo = response;
  
              for (endpoint in response['endpoints']) {
                const li = document.createElement('li');
                const button = document.createElement('button');
  
                button.classList.add('dropdown-item');
                button.setAttribute('onclick', 'selectItem(this);');
                button.textContent = endpoint;
                li.append(button);
                endpointList.appendChild(button);
              }
            });
          }
        });

        const selectEndpointObserver = new MutationObserver((mutations) => {
          const endpoint = mutations[0].target.textContent;
          const existedRow = fileUploadForm.querySelectorAll('.row');
          
          for (let i = 1; i < existedRow.length; ++i) {
            fileUploadForm.removeChild(existedRow[i]);
          }
          
          if (modelInfo['endpoints'][endpoint] != undefined) {
            const parameters = modelInfo['endpoints'][endpoint];
            const submitButton = document.createElement('button');

            fileUploadForm.classList.remove('hidden');

            for (parameter in parameters) {
              if (parameter == 'file') {
                for (parameterName in parameters[parameter]) {
                  inputImage.setAttribute('name', parameterName);
                }
              } else if (parameter == 'string') {
                for (parameterName in parameters[parameter]) {
                  const rowDiv = document.createElement('div');
                  const label = document.createElement('label');
                  const colDiv = document.createElement('div');
                  const select = document.createElement('select');
  
                  rowDiv.classList.add('row');
                  label.classList.add('col-sm-2', 'col-form-label');
                  label.setAttribute('for', parameterName);
                  label.textContent = parameterName;
                  colDiv.classList.add('col-sm-10');
                  select.setAttribute('type', 'text');
                  select.classList.add('form-select');
                  select.id = parameterName;

                  for (example of parameters[parameter][parameterName]) {
                    console.log(example)
                    const option = document.createElement('option');

                    option.value = example;
                    option.textContent = example;

                    select.append(option);
                  }
  
                  colDiv.append(select);
                  rowDiv.append(label, colDiv);
                  fileUploadForm.append(rowDiv);
                }
              }
            }
            const rowDiv = document.createElement('div');

            rowDiv.classList.add('row');

            submitButton.classList.add('btn', 'btn-primary');
            submitButton.id = 'submit';
            submitButton.textContent = 'Submit';
            submitButton.setAttribute('onclick', 'submitForm();');

            rowDiv.append(submitButton);
            fileUploadForm.append(rowDiv);

          } else {
            fileUploadForm.classList.add('hidden');
          }
        });

        const observerConfig = {
          childList: true,
        };
        
        selectCategoryObserver.observe(selectedCategory, observerConfig);
        selectModelObserver.observe(selectedModel, observerConfig);
        selectEndpointObserver.observe(selectedEndpoint, observerConfig);
        
        fetch("/category", {
          method: 'GET',
        }).then((response) => {
          if (response.status == 200) {
            return response;
          } else {
            throw Error('Server Error');
          }
        }).then((response) => {
          return response.json();
        }).then((response) => {
          const categoryList = document.getElementById('category-list');
          
          for (category of response) {
            const li = document.createElement('li');
            const button = document.createElement('button');

            button.classList.add('dropdown-item');
            button.setAttribute('onclick', 'selectItem(this);');
            button.textContent = category;
            li.append(button);
            categoryList.appendChild(button);
          }
        });

        function uploadImagePreview(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();

                reader.onload = (e) => {
                    const previewImage = document.getElementById('preview-image');
                    previewImage.src = e.target.result;
                }

                reader.readAsDataURL(input.files[0]);
            }
        }

        function selectItem(element) {
          const dropDownList = element.parentElement;
          const selectedItem = document.getElementById(dropDownList.getAttribute('aria-labelledby'));

          selectedItem.firstElementChild.innerHTML = element.textContent;
        }

        inputImage.addEventListener('change', (e) => {
            uploadImagePreview(e.target);
        });

        function submitForm() {
          const submitButton = document.getElementById('submit');
          const formRowList = fileUploadForm.getElementsByClassName('row');

          submitButton.disabled = true;

          const formData = new FormData();
          formData.append('category', selectedCategory.textContent);
          formData.append('model', selectedModel.textContent);
          formData.append('endpoint', selectedEndpoint.textContent);
          formData.append(inputImage.getAttribute('name'), inputImage.files[0]);

          for (let i = 1; i < formRowList.length - 1; ++i) {
            const formSelect = formRowList[i].querySelector('.form-select');
            console.log(formSelect.value);
            formData.append(formSelect.id, formSelect.value);
          }

          fetch('/gan', {
            method: 'POST',
            body: formData,
          }).then((response) => {
            if (response.status == 200) {
              return response;
            } else {
              return response.text().then((text) => { throw new Error(text) });
            }
          }).then((response) => {
            return response.blob();
          }).then((response) => {
            const url = URL.createObjectURL(response);
            const resultContainer = document.getElementById('result-container');
            const img = document.createElement('img');

            img.width = 300;
            img.height = 300;
            img.src = url;

            resultContainer.append(img);
            submitButton.disabled = false;
          }).catch((e) => {
            alert(e);
            submitButton.disabled = false;
          });
        }
    </script>
</body>

</html>